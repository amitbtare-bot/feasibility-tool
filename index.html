<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Small-Scale Chemical Feasibility Platform</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Segoe UI;background:#1f2a44;color:#fff;margin:0}
header{text-align:center;padding:20px}
main{max-width:1200px;margin:auto;background:#f4f6f8;color:#222;padding:30px;border-radius:14px}

label{font-weight:600;margin-top:10px;display:block}
input,button{width:100%;padding:8px;margin-top:6px}
button{background:#263238;color:#fff;border:none;margin-top:12px;cursor:pointer}

#chemResults{
  background:#fff;color:#000;border-radius:6px;
  max-height:220px;overflow:auto;display:none;
  border:1px solid #ccc;
}
#chemResults div{
  padding:6px;cursor:pointer;border-bottom:1px solid #eee;
}
#chemResults div:hover{background:#e0e0e0}

.small{font-size:12px;color:#555}

.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
gap:15px;margin-top:20px}
.card{background:#263238;color:#fff;padding:15px;border-radius:10px;text-align:center}

.verdict{padding:15px;border-radius:10px;font-size:18px;margin-top:20px}
.good{background:#2e7d32}
.warn{background:#ef6c00}
.bad{background:#c62828}

table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{border:1px solid #bbb;padding:6px;text-align:center;font-size:14px}

.altBox{
  background:#eef3f7;
  border-left:5px solid #263238;
  padding:15px;
  margin-top:25px;
  border-radius:8px;
}

canvas{margin-top:25px}
footer{text-align:center;padding:15px;opacity:.8}
</style>
</head>

<body>

<header>
<h1>Small-Scale Chemical Feasibility Tool</h1>
<p>Scale-first feasibility ‚Ä¢ Engineering-driven</p>
</header>

<main>

<label>Search Chemical</label>
<input type="text" id="chemSearch"
  placeholder="ethyl, resin, 141-78-6, esterification..."
  oninput="filterChemicals()">

<div id="chemResults"></div>
<input type="hidden" id="chemical">

<label>Capacity (TPA)</label>
<input type="number" id="scale" value="2500" oninput="evaluate()">

<button onclick="evaluate()">Evaluate Feasibility</button>

<div class="grid">
  <div class="card"><h3>CAPEX Range</h3><div id="capex">‚Äî</div></div>
  <div class="card"><h3>OPEX (‚Çπ/t)</h3><div id="opex">‚Äî</div></div>
  <div class="card"><h3>EBITDA %</h3><div id="ebitda">‚Äî</div></div>
  <div class="card"><h3>Ideal Scale</h3><div id="ideal">‚Äî</div></div>
</div>

<div id="verdictBox" class="verdict">Select a chemical to evaluate</div>

<button onclick="downloadReport()">üìÑ Download Feasibility Report (PDF)</button>

<h2>Utilities & Manpower</h2>
<table>
<tr><th>Parameter</th><th>Value</th></tr>
<tr><td>Steam (t/y)</td><td id="steam">‚Äî</td></tr>
<tr><td>Power (kWh/y)</td><td id="power">‚Äî</td></tr>
<tr><td>Manpower (Nos)</td><td id="manpower">‚Äî</td></tr>
</table>

<h2>Scale Sensitivity (EBITDA)</h2>
<canvas id="chart"></canvas>

<!-- üîÅ ALTERNATIVES -->
<div id="alternatives" class="altBox" style="display:none"></div>

</main>

<footer>
Concept-level ‚Ä¢ Indicative only ‚Ä¢ Not a substitute for detailed engineering
</footer>

<script>
let CHEM_DB=[],chart;

/* LOAD CSV */
async function loadChemicalDB(){
  const r=await fetch("chemicals.csv");
  const t=await r.text();
  const rows=t.trim().split("\n");
  const h=rows[0].split(",");
  CHEM_DB=rows.slice(1).map(r=>{
    const v=r.split(",");
    let o={};h.forEach((k,i)=>o[k.trim()]=(v[i]||"").trim());
    return o;
  });
}
loadChemicalDB();

/* SEARCH */
function filterChemicals(){
  const q=chemSearch.value.toLowerCase();
  chemResults.innerHTML="";
  if(q.length<2){chemResults.style.display="none";return;}
  CHEM_DB.filter(c=>
    c.chemical_name.toLowerCase().includes(q) ||
    (c.synonyms||"").toLowerCase().includes(q) ||
    (c.CAS_number||"").toLowerCase().includes(q) ||
    (c.process_family||"").toLowerCase().includes(q)
  ).forEach(c=>{
    const d=document.createElement("div");
    d.innerHTML=`<b>${c.chemical_name}</b><br><span class="small">${c.process_family||""}</span>`;
    d.onclick=()=>selectChemical(c);
    chemResults.appendChild(d);
  });
  chemResults.style.display="block";
}
function selectChemical(c){
  chemSearch.value=c.chemical_name;
  chemical.value=c.chemical_id;
  chemResults.style.display="none";
  evaluate();
}

/* CORE */
function evaluate(){
  if(!chemical.value)return;
  const c=CHEM_DB.find(x=>x.chemical_id===chemical.value);
  const S=+scale.value;

  const steam=(c.steam_intensity==="High"?1.4:c.steam_intensity==="Medium"?1.1:0.8)*S;
  const power=(c.power_intensity==="High"?110:c.power_intensity==="Medium"?90:70)*S;
  const manpower=S<3000?20:S<6000?28:35;

  const opex=+c.base_opex_rs_per_t+(S<c.ideal_scale_min_tpa?6000:0);
  const ebitda=((c.selling_price_rs_per_t-opex)/c.selling_price_rs_per_t*100).toFixed(1);

  capex.innerText=`‚Çπ${(c.base_capex_cr*0.85).toFixed(1)}‚Äì${(c.base_capex_cr*1.15).toFixed(1)} Cr`;
  opexEl.innerText=`‚Çπ${opex.toFixed(0)}`;
  ebitdaEl.innerText=`${ebitda} %`;
  ideal.innerText=`${c.ideal_scale_min_tpa}‚Äì${c.ideal_scale_max_tpa} TPA`;

  steamEl.innerText=Math.round(steam);
  powerEl.innerText=Math.round(power);
  manpowerEl.innerText=manpower;

  let v="Commercially Viable",cls="good";
  if(S<c.min_viable_tpa||ebitda<10){v="Not Recommended";cls="bad";}
  else if(S<c.ideal_scale_min_tpa||ebitda<15){v="Marginal ‚Äì Scale Sensitive";cls="warn";}
  verdictBox.className="verdict "+cls;
  verdictBox.innerText=v;

  drawChart(c);
  suggestAlternatives(c,S);
}

/* CHART */
function drawChart(c){
  const xs=[500,1000,2000,3000,5000,8000];
  const ys=xs.map(s=>{
    const o=+c.base_opex_rs_per_t+(s<c.ideal_scale_min_tpa?6000:0);
    return ((c.selling_price_rs_per_t-o)/c.selling_price_rs_per_t*100).toFixed(1);
  });
  if(chart)chart.destroy();
  chart=new Chart(chartCanvas,{type:"line",data:{labels:xs,datasets:[{label:"EBITDA %",data:ys,borderWidth:3}]}})
}

/* üîÅ ALTERNATIVES LOGIC */
function suggestAlternatives(base,cap){
  const box=document.getElementById("alternatives");
  const alts=CHEM_DB.filter(c=>
    c.chemical_id!==base.chemical_id &&
    c.process_family===base.process_family &&
    cap>=+c.ideal_scale_min_tpa &&
    cap<=+c.ideal_scale_max_tpa
  );

  if(!alts.length){box.style.display="none";return;}

  let html="<h3>üîÅ Better-suited alternatives at this capacity</h3><table><tr><th>Chemical</th><th>Why</th></tr>";
  alts.slice(0,4).forEach(c=>{
    html+=`<tr><td>${c.chemical_name}</td>
    <td>Ideal scale matches (${c.ideal_scale_min_tpa}‚Äì${c.ideal_scale_max_tpa} TPA)</td></tr>`;
  });
  html+="</table>";
  box.innerHTML=html;
  box.style.display="block";
}

/* PDF (unchanged, shortened for clarity) */
function downloadReport(){
  if(!chemical.value)return alert("Select a chemical first");
  const {jsPDF}=window.jspdf;
  const d=new jsPDF();
  d.text("Concept Feasibility Report",20,20);
  d.text("Chemical: "+chemSearch.value,20,30);
  d.text("Capacity: "+scale.value+" TPA",20,40);
  d.save(chemSearch.value+"_Report.pdf");
}

/* ELEMENTS */
const chemSearch=document.getElementById("chemSearch");
const chemResults=document.getElementById("chemResults");
const chemical=document.getElementById("chemical");

const capex=document.getElementById("capex");
const opexEl=document.getElementById("opex");
const ebitdaEl=document.getElementById("ebitda");
const ideal=document.getElementById("ideal");

const steamEl=document.getElementById("steam");
const powerEl=document.getElementById("power");
const manpowerEl=document.getElementById("manpower");
const verdictBox=document.getElementById("verdictBox");
const chartCanvas=document.getElementById("chart");
</script>

</body>
</html>
